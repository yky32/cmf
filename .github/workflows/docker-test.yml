name: Docker Build Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  actions: read
  contents: read

jobs:
  docker-test:
    runs-on: ubuntu-latest
    steps:
      - name: ☑️ Checkout code
        uses: actions/checkout@v4

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔨 Build Docker image
        run: |
          echo "🔨 Building Docker image..."
          docker build -t cmf:test .
          echo "✅ Docker build completed successfully"

      - name: 🧪 Test Docker image
        run: |
          echo "🧪 Testing Docker image..."
          
          # Test that the image starts without errors
          echo "Testing container startup..."
          CONTAINER_ID=$(docker run -d -p 8088:8088 cmf:test)
          sleep 10
          
          # Check if container is running
          if docker ps | grep -q $CONTAINER_ID; then
            echo "✅ Container started successfully"
            
            # Test health endpoint
            echo "Testing health endpoint..."
            if curl -f http://localhost:8088/health; then
              echo "✅ Health endpoint is working"
            else
              echo "❌ Health endpoint failed"
              exit 1
            fi
            
            # Clean up
            docker stop $CONTAINER_ID
            docker rm $CONTAINER_ID
          else
            echo "❌ Container failed to start"
            docker logs $CONTAINER_ID
            exit 1
          fi

      - name: 📊 Image analysis
        run: |
          echo "📊 Docker Image Analysis:"
          echo "  Image size: $(docker images cmf:test --format 'table {{.Size}}')"
          echo "  Image layers: $(docker history cmf:test --format 'table {{.CreatedBy}}' | wc -l)"
          
          # Show image details
          docker inspect cmf:test | jq '.[0].Config'
        shell: bash
