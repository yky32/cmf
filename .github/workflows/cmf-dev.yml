name: CMF Development Build and Test

on:
  push:
    branches:
      - develop
      - feature/*
  pull_request:
    branches:
      - develop
      - main

permissions:
  actions: read
  contents: read

env:
  NODE_VERSION: "20"
  DOCTL_VERSION: "1.127.0"
  CLUSTER_NAME: "k8s-tgt"
  NAMESPACE: "default"
  IMAGE_REPO: "registry.digitalocean.com/qs-ecr/cmf"
  IMAGE_TAG: "dev-${{ github.sha }}"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ☑️ Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📥 Install dependencies
        run: npm ci

      - name: 🔨 Build TypeScript
        run: npm run build

      - name: 🧪 Run tests (if available)
        run: npm test --if-present

      - name: 🔍 Lint code
        run: npm run lint --if-present

      - name: 🐳 Test Docker build
        run: |
          echo "🐳 Testing Docker build..."
          docker build -t cmf:test .
          echo "✅ Docker build test completed"

  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: ☑️ Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Authenticate with DigitalOcean
        uses: ./.github/actions/doctl-auth
        with:
          token: ${{ secrets.DIGITAL_OCEAN_DEPLOY_TOKEN }}
          doctl_version: ${{ env.DOCTL_VERSION }}

      - name: 🐳 Build and Push Docker Image
        uses: ./.github/actions/docker-push
        with:
          repo: ${{ env.IMAGE_REPO }}
          image_tag: ${{ env.IMAGE_TAG }}

      - name: 🚀 Deploy to Development
        uses: ./.github/actions/k8s-helm-deploy
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          namespace: ${{ env.NAMESPACE }}
          chart_path: "./k8s/helm/cmf"
          release_name: "cmf-dev"
          values_file: "./k8s/helm/cmf/values-dev.yaml"

      - name: 🎨 Deploy Client Simulator (Dev)
        uses: ./.github/actions/k8s-helm-deploy
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          namespace: ${{ env.NAMESPACE }}
          chart_path: "./k8s/cmf-client"
          release_name: "cmf-client-dev"
          values_file: "./k8s/cmf-client/values-dev.yaml"

  notify-dev:
    needs: [test, deploy-dev]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
      - name: 📣 Notify Discord on Success
        if: needs.test.result == 'success' && needs.deploy-dev.result == 'success'
        uses: ./.github/actions/notify-discord
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: "success"
          repo: ${{ github.repository }}
          run_number: ${{ github.run_number }}
          message: "🧪 CMF Development deployment successful!"

      - name: 📣 Notify Discord on Failure
        if: needs.test.result != 'success' || needs.deploy-dev.result != 'success'
        uses: ./.github/actions/notify-discord
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: "failure"
          repo: ${{ github.repository }}
          run_number: ${{ github.run_number }}
          message: "❌ CMF Development deployment failed!"
